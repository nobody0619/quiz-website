<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç« èŠ‚æµ‹éªŒç³»ç»Ÿ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:700px; margin:auto; text-align:center; }
    #menu { margin:20px 0; }
    #menu button { margin:0 5px; padding:5px 10px; }
    #quiz-title { font-size:1.8em; margin-bottom:10px; }
    #score,#remaining { font-size:1.2em; margin:5px 0; }
    #progress { width:100%; height:20px; }
    .question { text-align:left; margin:20px 0; }
    .options { text-align:left; }
    .option-label { display:block; margin:5px 0; cursor:pointer; }
    .feedback { font-weight:bold; margin:10px 0; }
    button { padding:8px 16px; margin:5px; }
    img { max-width: 100%; height:auto; margin:10px 0; }
  </style>
</head>
<body>
  <div id="menu">æ­£åœ¨åŠ è½½ç« èŠ‚...</div>
  <div id="quiz-title"></div>
  <div id="score">å¾—åˆ†: 0.0 (+0.0)</div>
  <div id="remaining">å‰©ä½™é¢˜ç›®: 0</div>
  <progress id="progress" value="0" max="0"></progress>
  <div id="quiz"></div>

  <script>
    let chapters = [], chapterButtons = {}, currentChapter = null;
    let questions = [], queue = [], score = 0, correct = 0, wrong = 0, total = 0;
    let chapterComplete = true, completedChapters = new Set();

    // Load chapters definitions
    Papa.parse('Chapters.csv', {
      download: true, header: true, skipEmptyLines: true, dynamicTyping: false,
      complete: function(res) {
        chapters = res.data;
        const menu = document.getElementById('menu');
        menu.innerHTML = 'é€‰æ‹©ç« èŠ‚: ';
        chapters.forEach(ch => {
          let btn = document.createElement('button');
          btn.textContent = ch.label;
          btn.onclick = () => selectChapter(ch.sheet, ch.label);
          chapterButtons[ch.sheet] = btn;
          menu.appendChild(btn);
        });
      }
    });

    function selectChapter(sheet, label) {
      if (currentChapter && !chapterComplete) {
        if (!confirm('å½“å‰ç« èŠ‚æœªå®Œæˆï¼Œç¡®å®šè¦åˆ‡æ¢ç« èŠ‚å—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
          return;
        }
      }
      loadChapter(sheet, label);
    }

    function loadChapter(csv, label) {
      Papa.parse(csv, {
        download: true, header: true, skipEmptyLines: true, dynamicTyping: false,
        complete: function(res) {
          questions = res.data.map(q => ({...q, attempt: 0}));
          document.getElementById('quiz-title').textContent = label;
          score = 0; correct = 0; wrong = 0; total = questions.length;
          queue = shuffle([...questions]);
          currentChapter = csv; chapterComplete = false;
          document.getElementById('progress').max = total;
          updateScore(0); updateRemaining(); nextQuestion();
        }
      });
    }

    function updateScore(delta) {
      document.getElementById('score').textContent = 'å¾—åˆ†: ' + score.toFixed(1) +
        ' (' + (delta>0?'+':'') + delta.toFixed(1) + ')';
    }
    function updateRemaining() {
      document.getElementById('remaining').textContent = 'å‰©ä½™é¢˜ç›®: ' + queue.length;
      document.getElementById('progress').value = total - queue.length;
    }

    function nextQuestion() {
      const quiz = document.getElementById('quiz'); quiz.innerHTML = '';
      updateRemaining();
      if (queue.length === 0) {
        chapterComplete = true;
        completedChapters.add(currentChapter);
        // update button label with score
        chapterButtons[currentChapter].textContent = document.getElementById('quiz-title').textContent +
          ' (' + score.toFixed(1) + ' åˆ†)';
        // show completion message
        quiz.innerHTML = '<h3>ç« èŠ‚å®Œæˆ</h3>' +
          '<p>æœ¬ç« å¾—åˆ†: ' + score.toFixed(1) + '</p>' +
          '<p>ç­”å¯¹: ' + correct + 'ï¼Œç­”é”™: ' + wrong + '</p>';
        // if all completed, show achievement
        if (completedChapters.size === chapters.length) {
          quiz.innerHTML += '<h2>ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰ç« èŠ‚ï¼</h2>';
        }
        return;
      }
      let q = queue.shift();
      let div = document.createElement('div'); div.className = 'question';
      div.innerHTML = '<p><strong>' + q.question + '</strong></p>';
      if (q.image) {
        let img = document.createElement('img'); img.src = q.image; div.appendChild(img);
      }
      let opts = document.createElement('div'); opts.className = 'options';
      if (q.type === 'text') {
        opts.innerHTML = '<input type="text" id="txtAns" placeholder="è¯·è¾“å…¥ç­”æ¡ˆï¼Œç”¨é€—å·åˆ†éš”å¤šç­”æ¡ˆ">';
      } else {
        let keys = ['A','B','C','D','E','F','G','H'].filter(k => q[k]);
        shuffle(keys);
        keys.forEach(l => {
          let input = document.createElement('input');
          input.type = (q.type==='checkbox')?'checkbox':'radio';
          input.name = 'opt'; input.value = l; input.id = 'opt_'+l;
          let lbl = document.createElement('label');
          lbl.htmlFor = 'opt_'+l; lbl.className = 'option-label';
          lbl.appendChild(input); lbl.append(' ' + q[l]);
          opts.appendChild(lbl);
        });
      }
      div.appendChild(opts);
      let fb = document.createElement('div'); fb.className='feedback'; div.appendChild(fb);

      let sub = document.createElement('button'); sub.textContent='æäº¤';
      sub.onclick = function() {
        let ua = [];
        if (q.type === 'text') {
          ua = document.getElementById('txtAns').value.split(',').map(s=>s.trim()).filter(s=>s);
        } else {
          ua = Array.from(div.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
        }
        if (!ua.length) return alert('è¯·é€‰æ‹©æˆ–è¾“å…¥ç­”æ¡ˆ');
        let uaArr = ua.map(s=>s.toUpperCase()).sort();
        let caArr = q.answer.split(',').map(s=>s.trim().toUpperCase()).sort();
        let delta = 0;
        if (q.type==='text') {
          // any one correct
          delta = uaArr.some(v=>caArr.includes(v)) ? (q.attempt?1:2) : -1;
        } else {
          delta = (uaArr.join(',')===caArr.join(',')) ? (q.attempt?1:2) : -1;
        }
        score += delta; if(delta>0) correct++; else wrong++;
        let ansText = q.type==='text' ? caArr.join(' / ') : caArr.map(l=>q[l]).join(' / ');
        fb.textContent = (delta>0?'æ­£ç¡®! +':'é”™è¯¯! ') + delta.toFixed(1) +
          (delta<0 ? ' æ­£ç¡®ç­”æ¡ˆ: ' + ansText : '');
        updateScore(delta); updateRemaining();
        sub.disabled = true; nextBtn.style.display='inline-block';
        if (delta < 0) {
          q.attempt++;
          for (let i=0;i<2;i++){
            let clone = {...q};
            queue.splice(Math.floor(Math.random()*(queue.length+1)),0,clone);
          }
        }
      };
      div.appendChild(sub);

      let nextBtn = document.createElement('button');
      nextBtn.textContent='ä¸‹ä¸€é¢˜'; nextBtn.style.display='none';
      nextBtn.onclick = nextQuestion; div.appendChild(nextBtn);

      quiz.appendChild(div);
    }

    function shuffle(arr) {
      for (let i=arr.length-1;i>0;i--){
        let j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }
  </script>
</body>
</html>
