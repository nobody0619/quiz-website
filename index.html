<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>多 Quiz 系统 (JSONP 版)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:auto; max-width:700px; text-align:center; font-size:18px; }
    #welcome,#main,#global-board { margin:20px; }
    #main { display:none; }
    #menu button { margin:0 5px; padding:6px 12px; }
    .question { text-align:left; margin:15px 0; padding-left:20px; }
    .options { text-align:left; padding-left:20px; }
    .feedback { font-weight:bold; margin:10px 0; }
    input[type="text"] { width:100%; padding:6px; }
    input[type="radio"],input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border:1px solid #ccc; padding:8px; }
    th { background:#eee; }
  </style>
</head>
<body>

  <div id="welcome">
    <h2>请输入姓名 / Enter Your Name</h2>
    <input type="text" id="username" placeholder="姓名 / Name">
    <button id="startBtn" type="button">开始测验 / Start Quiz</button>
  </div>

  <div id="main">
    <div id="menu">加载章节…</div>
    <h3 id="quiz-title"></h3>
    <div id="score">得分: 0</div>
    <div id="remaining">剩余题目: 0</div>
    <div id="timer">用时: 0分0秒</div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="quiz"></div>
  </div>

  <div id="global-board"></div>

  <!-- 隐藏 iframe 用于无 CORS form POST -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm" action="https://script.google.com/macros/s/AKfycbx7QMIvwI56vwlKmGK2-IjqH06QC3htFebrkAJ2DUnYlwHnKD6x8pENjF23PwkPDRyK/exec"
        method="POST" target="postFrame" style="display:none;">
    <input name="quizId">
    <input name="name">
    <input name="score">
    <input name="time">
  </form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_URL = 'https://script.google.com/macros/s/AKfycbx7QMIvwI56vwlKmGK2-IjqH06QC3htFebrkAJ2DUnYlwHnKD6x8pENjF23PwkPDRyK/exec';

  let user='', currentQuizId='', chapterStart=0, chapterTimer=null;
  let buttons={}, currentCsv=null, qs=[], queue=[], score=0, total=0, complete=true;

  // 点击开始
  document.getElementById('startBtn').onclick = () => {
    const nm = document.getElementById('username').value.trim();
    if (!nm) return alert('请输入姓名');
    user = nm;
    document.getElementById('welcome').style.display='none';
    document.getElementById('main').style.display='block';
    loadChapters();
  };

  // 加载章节列表
  function loadChapters(){
    Papa.parse('Chapters.csv',{download:true,header:true,skipEmptyLines:true,
      complete(res){
        const menu = document.getElementById('menu');
        menu.innerHTML = '选择章节:';
        res.data.forEach(ch=>{
          const quizId = ch.sheet.replace('.csv','');
          const btn = document.createElement('button');
          btn.textContent = ch.label;
          btn.onclick = ()=> selectChap(ch.sheet, ch.label, quizId);
          buttons[ch.sheet]=btn;
          menu.appendChild(btn);
        });
      }
    });
  }

  // 选章节
  function selectChap(csv,label,quizId){
    if (currentCsv && !complete && !confirm('章节未完成，切换将丢失进度？')) return;
    startChap(csv,label,quizId);
  }

  // 启动章节
  function startChap(csv,label,quizId){
    Papa.parse(csv,{download:true,header:true,skipEmptyLines:true,
      complete(res){
        qs = res.data.map(q=>({...q,attempt:0}));
        score=0; total=qs.length; queue=shuffle([...qs]);
        currentCsv=csv; currentQuizId=quizId; complete=false;
        document.getElementById('quiz-title').textContent=label;
        document.getElementById('progress').max=total;
        clearInterval(chapterTimer);
        chapterStart=Date.now();
        document.getElementById('timer').textContent='用时: 0分0秒';
        chapterTimer = setInterval(updateTimer,1000);
        updateUI(0); nextQ();
        loadGlobalBoard(); // 立即 JSONP 拉取榜单
      }
    });
  }

  // 更新计时
  function updateTimer(){
    const sec=Math.floor((Date.now()-chapterStart)/1000);
    const m=Math.floor(sec/60), s=sec%60;
    document.getElementById('timer').textContent=`用时: ${m}分${s}秒`;
  }

  // 更新分数/剩余
  function updateUI(delta){
    document.getElementById('score').textContent = `得分: ${score} (${delta>0?'+':''}${delta})`;
    document.getElementById('remaining').textContent = `剩余题目: ${queue.length}`;
    document.getElementById('progress').value = total - queue.length;
  }

  // 渲染下一题 or 完成
  function nextQ(){
    const qz = document.getElementById('quiz'); qz.innerHTML=''; updateUI(0);
    if (queue.length===0){
      complete=true; clearInterval(chapterTimer);
      const dur=Math.floor((Date.now()-chapterStart)/1000);
      const m=Math.floor(dur/60), s=dur%60, tstr=`${m}分${s}秒`;
      buttons[currentCsv].textContent = `${document.getElementById('quiz-title').textContent} (${score} 分)`;
      qz.innerHTML = `<h3>章节完成</h3><p>本章得分: ${score}，用时: ${tstr}</p>`;
      // form POST 提交成绩
      const f=document.getElementById('postForm');
      f.quizId.value=currentQuizId;
      f.name.value=user;
      f.score.value=score;
      f.time.value=dur;
      f.submit();
      // JSONP 延迟刷新榜单
      setTimeout(loadGlobalBoard, 1000);
      return;
    }
    // ... 渲染题目逻辑同前，只是评分 delta 错题重练为 -2 ...
    const q=queue.shift();
    const d=document.createElement('div'); d.className='question';
    d.innerHTML=`<p><strong>${q.question}</strong></p>`;
    if(q.image){const im=document.createElement('img');im.src=q.image;d.appendChild(im);}
    const opts=document.createElement('div'); opts.className='options';
    if(q.type==='text'){
      opts.innerHTML='<input type="text" id="txtAns" placeholder="请输入答案，用逗号分隔">';
    } else {
      shuffle(['A','B','C','D','E','F','G','H'].filter(k=>q[k]))
      .forEach(l=>{
        const inp=document.createElement('input');
        inp.type=(q.type==='checkbox'?'checkbox':'radio');
        inp.name='opt'; inp.value=l; inp.id='opt_'+l;
        const lbl=document.createElement('label');
        lbl.htmlFor='opt_'+l; lbl.className='option-label';
        lbl.appendChild(inp);
        let raw=q[l]; if(/^-?\\d+\\.0$/.test(raw)) raw=String(parseInt(raw));
        lbl.append(' '+raw);
        opts.appendChild(lbl);
      });
    }
    d.appendChild(opts);
    const fb=document.createElement('div'); fb.className='feedback'; d.appendChild(fb);
    const sb=document.createElement('button'); sb.textContent='提交';
    sb.onclick=()=>{
      let ua=[];
      if(q.type==='text'){
        ua=document.getElementById('txtAns').value.split(',')
          .map(s=>s.trim()).filter(s=>s);
      } else {
        ua=Array.from(d.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
      }
      if(!ua.length) return alert('请选择或输入答案');
      let isCorrect=false;
      if(q.type==='text'){
        const a=ua.map(s=>s.toLowerCase()), b=q.answer.split(',').map(s=>s.toLowerCase());
        isCorrect=a.some(v=>b.includes(v));
      } else {
        const a=ua.map(s=>s.toUpperCase()).sort().join(','),
              b=q.answer.split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
        isCorrect=(a===b);
      }
      const delta = isCorrect ? (q.attempt?1:2) : (q.attempt?-2:-1);
      score+=delta;
      let ansTxt='';
      if(delta<0){
        ansTxt=q.answer.split(',').map(letter=>q[letter]||letter).join(' / ');
      }
      fb.textContent = isCorrect
        ? `正确! +${delta}`
        : `错误! ${delta} 正确答案: ${ansTxt}`;
      updateUI(delta);
      sb.disabled=true; nb.style.display='inline-block';
      if(!isCorrect){
        q.attempt++;
        for(let i=0;i<2;i++){
          queue.splice(Math.floor(Math.random()*(queue.length+1)),0,{...q});
        }
      }
    };
    d.appendChild(sb);
    const nb=document.createElement('button');
    nb.textContent='下一题'; nb.style.display='none'; nb.onclick=nextQ;
    d.appendChild(nb);
    qz.appendChild(d);
  }

  // JSONP 加载全局排行榜
  window.processLeaderboard = function(rows){
    const el = document.getElementById('global-board');
    if(!rows||!rows.length){
      el.innerHTML='<p>暂无排行榜，完成章节后可见</p>'; return;
    }
    rows.sort((a,b)=>b[2]-a[2]||a[3]-b[3]);
    const top5=rows.slice(0,5);
    let html='<h3>全局排行榜 Top 5</h3><table><tr><th>排名</th><th>姓名</th><th>得分</th><th>用时</th></tr>';
    top5.forEach((r,i)=>{
      const mm=Math.floor(r[3]/60), ss=r[3]%60;
      html+=`<tr><td>${i+1}</td><td>${r[1]}</td><td>${r[2]}</td><td>${mm}分${ss}秒</td></tr>`;
    });
    html+='</table>'; el.innerHTML=html;
  };

  function loadGlobalBoard(){
    // 插入 JSONP 脚本
    const s=document.createElement('script');
    s.src = API_URL + '?quizId=' + encodeURIComponent(currentQuizId)
          + '&callback=processLeaderboard';
    document.body.appendChild(s);
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

}); // DOMContentLoaded
</script>
</body>
</html>
