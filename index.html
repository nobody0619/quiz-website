<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>纪老师棒棒哒~</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:700px; margin:auto; text-align:center; }
    #menu, #quiz, #finish { margin:20px; }
    #menu button, #controls button { margin:5px; padding:8px 12px; }
    .question { text-align:left; margin:15px 0; padding-left:20px; }
    .option-label { display:block; margin:5px 0; cursor:pointer; }
    .feedback { font-weight:bold; margin:10px 0; }
    progress { width:100%; height:20px; }
  </style>
</head>
<body>

  <div id="menu">
    <h2>请选择章节 / Select Chapter</h2>
    <!-- 章节按钮由 JS 动态插入 -->
  </div>

  <div id="quiz" style="display:none;">
    <h3 id="quiz-title"></h3>
    <div id="score">得分: 0</div>
    <div id="remaining">剩余题目: 0</div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="question-area"></div>
  </div>

  <div id="finish" style="display:none;">
    <h3 id="finish-msg"></h3>
    <p id="stats"></p>
    <div id="controls"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=> {
  // 全局变量
  let user='';                  // 可扩展：按需加姓名输入逻辑
  let chapters=[];              // 从 CSV 读的所有行
  let grouped={};               // 按 chapter 分组后的对象
  let currentChapter='';        
  let sectionList=[];           // 本章的 section 顺序数组
  let secIndex=0;               // 当前执行到第几个 section
  let qs=[], queue=[];          
  let score=0, correct=0, wrong=0;
  const MAX_OPTS=15;            // A~O

  // 加载 Chapters.csv
  Papa.parse('Chapters.csv',{download:true,header:true,skipEmptyLines:true,
    complete(r) {
      chapters = r.data;
      // 按 chapter 分组
      chapters.forEach(row=>{
        if(!grouped[row.chapter]) grouped[row.chapter]=[];
        grouped[row.chapter].push(row);
      });
      // 渲染章节按钮
      const menu = document.getElementById('menu');
      for(const chap of Object.keys(grouped)) {
        const btn = document.createElement('button');
        btn.textContent = chap;
        btn.onclick = ()=>startChapter(chap);
        menu.appendChild(btn);
      }
    }
  });

  function startChapter(chap) {
    currentChapter = chap;
    sectionList = grouped[chap]
                    .sort((a,b)=>a.section.localeCompare(b.section))
                    .map(r=>r);
    secIndex = 0;
    document.getElementById('menu').style.display='none';
    loadSection();
  }

  function loadSection() {
    const sec = sectionList[secIndex];
    document.getElementById('quiz-title').textContent = 
      `${currentChapter} – ${sec.section}: ${sec.label}`;
    // 重置题目队列和统计
    score = correct = wrong = 0;
    qs=[]; queue=[];
    Papa.parse(sec.sheet,{download:true,header:true,skipEmptyLines:true,
      complete(r) {
        qs = r.data.map(q=>({...q,attempt:0}));
        queue = shuffle([...qs]);
        document.getElementById('quiz').style.display='block';
        document.getElementById('finish').style.display='none';
        updateUI(0);
        nextQ();
      }
    });
  }

  function updateUI(delta) {
    document.getElementById('score').textContent = `得分: ${score} (${delta>0?'+':''}${delta})`;
    document.getElementById('remaining').textContent = `剩余题目: ${queue.length}`;
    document.getElementById('progress').max = qs.length;
    document.getElementById('progress').value = qs.length - queue.length;
  }

  function nextQ() {
    const qa = document.getElementById('question-area');
    qa.innerHTML='';
    updateUI(0);
    if(queue.length===0) return finishSection();
    const q = queue.shift();
    const div = document.createElement('div'); div.className='question';
    div.innerHTML = `<p><strong>${q.question}</strong></p>`;
    const opts = document.createElement('div'); opts.className='options';

    if(q.type==='text') {
      opts.innerHTML = `<input type="text" id="txtAns" placeholder="请输入答案…">`;
    } else {
      const letters = Array.from({length:MAX_OPTS},(_,i)=>String.fromCharCode(65+i));
      shuffle(letters.filter(l=>q[l])).forEach(l=>{
        const inp = document.createElement('input');
        inp.type = q.type==='checkbox'?'checkbox':'radio';
        inp.name = 'opt'; inp.value = l; inp.id='opt_'+l;
        const lbl = document.createElement('label'); lbl.className='option-label';
        lbl.htmlFor='opt_'+l; lbl.appendChild(inp);
        let raw = q[l]; if(/^-?\d+\.0$/.test(raw)) raw=String(parseInt(raw));
        lbl.append(' '+raw);
        opts.appendChild(lbl);
      });
    }
    div.appendChild(opts);

    const fb = document.createElement('div'); fb.className='feedback'; div.appendChild(fb);
    const sb = document.createElement('button'); sb.textContent='提交';
    sb.onclick = ()=>{
      let ua = [];
      if(q.type==='text'){
        ua = document.getElementById('txtAns').value.split(',').map(s=>s.trim()).filter(s=>s);
      } else {
        ua = Array.from(div.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
      }
      if(!ua.length) return alert('请选择或输入答案');
      let isC=false;
      if(q.type==='text'){
        const lows=ua.map(s=>s.toLowerCase());
        const ansList=q.answer.split(',').map(s=>s.toLowerCase());
        isC=lows.some(v=>ansList.includes(v));
      } else {
        const uaA=ua.map(s=>s.toUpperCase()).sort().join(',');
        const caA=q.answer.split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
        isC = uaA===caA;
      }
      const delta = isC?(q.attempt?1:2):(q.attempt?-2:-1);
      score += delta; if(isC) correct++; else wrong++;
      let ansTxt='';
      if(delta<0){
        ansTxt=q.answer.split(',').map(letter=>q[letter]||letter).join(' / ');
      }
      fb.textContent = isC?`正确! +${delta}`:`错误! ${delta} 正确答案: ${ansTxt}`;
      updateUI(delta);
      sb.disabled=true;
      const nb = document.createElement('button');
      nb.textContent='下一题'; nb.onclick=nextQ;
      div.appendChild(nb);
      if(!isC){
        q.attempt++;
        for(let i=0;i<2;i++){
          queue.splice(Math.floor(Math.random()*(queue.length+1)),0, {...q});
        }
      }
    };
    div.appendChild(sb);

    qa.appendChild(div);
  }

  function finishSection() {
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='block';
    document.getElementById('finish-msg').textContent = '恭喜！本节完成 🎉';
    document.getElementById('stats').textContent = 
      `得分: ${score}，答对 ${correct} 题，答错 ${wrong} 题`;
    const ctrl = document.getElementById('controls'); ctrl.innerHTML='';
    const nextBtn = document.createElement('button');
    nextBtn.textContent = (secIndex < sectionList.length-1) 
      ? '下一节' 
      : '返回章节选择';
    nextBtn.onclick = ()=>{
      document.getElementById('finish').style.display='none';
      if(secIndex < sectionList.length-1) {
        secIndex++;
        loadSection();
      } else {
        document.getElementById('menu').style.display='block';
      }
    };
    ctrl.appendChild(nextBtn);
  }

  function shuffle(arr) {
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
});
</script>

</body>
</html>
