
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>章节测验系统</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:700px; margin:auto; text-align:center; }
    #menu { margin:20px 0; }
    #menu button { margin:0 5px; padding:5px 10px; }
    #quiz-title { font-size:1.8em; margin-bottom:10px; }
    #score,#remaining { font-size:1.2em; margin:5px 0; }
    #progress { width:100%; height:20px; }
    .question { text-align:left; margin:20px 0; }
    .options { text-align:left; }
    .option-label { display:block; margin:5px 0; }
    .feedback { font-weight:bold; margin:10px 0; }
    button { padding:8px 16px; margin:5px; }
  </style>
</head>
<body>
  <div id="menu">加载中章节...</div>
  <div id="quiz-title"></div>
  <div id="score">得分: 0.0 (+0.0)</div>
  <div id="remaining">剩余题目: 0</div>
  <progress id="progress" value="0" max="0"></progress>
  <div id="quiz"></div>

  <script>
    let chapters = [];
    Papa.parse('Chapters.csv', {
      download:true,header:true,skipEmptyLines:true,
      complete:function(res) {
        chapters = res.data;
        const menu = document.getElementById('menu');
        menu.innerHTML = '选择章节: ';
        chapters.forEach(ch => {
          const btn = document.createElement('button');
          btn.textContent = ch.label;
          btn.onclick = ()=> loadChapter(ch.sheet);
          menu.appendChild(btn);
        });
      }
    });

    let questions =[], queue=[],score=0,correct=0,wrong=0,total=0;
    function loadChapter(csv) {
      Papa.parse(csv, {
        download:true,header:true,skipEmptyLines:true,
        complete:function(res) {
          questions = res.data.map(q=>({...q,attempt:0}));
          const title = questions[0].title || '';
          document.getElementById('quiz-title').textContent = title;
          score=0;correct=0;wrong=0;total=questions.length;
          queue = shuffle([...questions]);
          document.getElementById('progress').max = total;
          updateScore(0); updateRemaining(); nextQuestion();
        }
      });
    }

    function updateScore(delta) {
      document.getElementById('score').textContent = 
        '得分: '+score.toFixed(1)+' ('+(delta>0?'+':'')+delta.toFixed(1)+')';
    }
    function updateRemaining() {
      document.getElementById('remaining').textContent = 
        '剩余题目: '+queue.length;
      document.getElementById('progress').value = total-queue.length;
    }

    function nextQuestion() {
      const quiz = document.getElementById('quiz'); quiz.innerHTML='';
      updateRemaining();
      if(!queue.length) {
        quiz.innerHTML = '<h3>测验完成</h3>'
          + '<p>最终得分: '+score.toFixed(1)+'</p>'
          + '<p>答对: '+correct+'，答错: '+wrong+'</p>';
        return;
      }
      const q=queue.shift(), div=document.createElement('div'); div.className='question';
      div.innerHTML = '<p><strong>'+q.question+'</strong></p>';
      if(q.image) { const img=document.createElement('img'); img.src=q.image; div.appendChild(img); }
      const opts=document.createElement('div'); opts.className='options';
      if(q.type==='text') opts.innerHTML='<input type="text" id="txtAns" placeholder="请输入答案，用逗号分隔多答案">';
      else {
        let keys=['A','B','C','D','E','F','G','H'].filter(k=>q[k]);
        shuffle(keys);
        keys.forEach(l=>{
          const inp=document.createElement('input'); inp.type=(q.type==='checkbox'?'checkbox':'radio');
          inp.name='opt'; inp.value=l; inp.id='opt_'+l;
          const lbl=document.createElement('label'); lbl.htmlFor='opt_'+l; lbl.className='option-label';
          lbl.appendChild(inp); lbl.append(' '+q[l]);
          opts.appendChild(lbl);
        });
      }
      div.appendChild(opts);
      const fb=document.createElement('div'); fb.className='feedback'; div.appendChild(fb);
      const sub=document.createElement('button'); sub.textContent='提交';
      sub.onclick=function(){
        let ua=[]; if(q.type==='text') ua=document.getElementById('txtAns').value.split(',').map(s=>s.trim()).filter(s=>s);
        else ua=Array.from(div.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
        if(!ua.length) return alert('请选择或输入答案');
        const uaS=ua.map(s=>s.toUpperCase()).sort().join(','),
              ca=q.answer.split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
        let delta=uaS===ca?(q.attempt?0.5:1):-0.5;
        score+=delta; if(delta>0) correct++; else wrong++;
        let ansText=q.type==='text'?q.answer:ca.split(',').map(l=>q[l]).join(' / ');
        fb.textContent=(delta>0?'正确! +':'错误! ')+delta.toFixed(1)+(delta<0?' 正确答案: '+ansText:'');
        updateScore(delta); updateRemaining();
        sub.disabled=true; nextBtn.style.display='inline-block';
        if(delta<0){q.attempt++; for(let i=0;i<2;i++){queue.splice(Math.floor(Math.random()*(queue.length+1)),0,{...q});}}
      };
      div.appendChild(sub);
      const nextBtn=document.createElement('button'); nextBtn.textContent='下一题';
      nextBtn.style.display='none'; nextBtn.onclick=nextQuestion; div.appendChild(nextBtn);
      quiz.appendChild(div);
    }

    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
  </script>
</body>
</html>
