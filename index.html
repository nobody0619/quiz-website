<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>章节测验系统</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:auto; max-width:700px; text-align:center; font-size:18px; }
    #welcome { margin:20px; }
    #main { display:none; }
    #menu { margin:20px 0; }
    #menu button { margin:0 5px; padding:10px 12px; font-size:1em; }
    #quiz-title { font-size:1.8em; margin-bottom:10px; }
    #score,#remaining { font-size:1.2em; margin:5px 0; }
    #progress { width:100%; height:20px; margin-bottom:10px;}
    .question { text-align:left; margin:20px 0; padding-left:20px; }
    .options { text-align:left; padding-left:20px; }
    .option-label { display:block; margin:5px 0; cursor:pointer; }
    .feedback { font-weight:bold; margin:10px 0; }
    button { padding:8px 16px; margin:5px; font-size:1em; }
    input[type="text"] { width:100%; padding:8px; font-size:1em; margin-top:10px; }
    input[type="radio"], input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
    table { width:100%; border-collapse:collapse; margin-top:10px;}
    th,td { border:1px solid #ccc; padding:8px; }
    th { background:#eee;}
  </style>
</head>
<body>
  <div id="welcome">
    <h2>请输入姓名 / Enter Your Name</h2>
    <input type="text" id="username" placeholder="姓名 / Name">
    <button id="startBtn">开始测验 / Start Quiz</button>
  </div>
  <div id="main">
    <div id="menu">正在加载章节...</div>
    <div id="quiz-title"></div>
    <div id="score">得分: 0</div>
    <div id="remaining">剩余题目: 0</div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="quiz"></div>
  </div>
<script>
let user='', startTime=0;
document.getElementById('startBtn').onclick = ()=>{
  let nm=document.getElementById('username').value.trim();
  if(!nm) return alert('请输入姓名 / Please enter your name');
  user=nm;
  document.getElementById('welcome').style.display='none';
  document.getElementById('main').style.display='block';
  startTime=Date.now(); loadChapters();
};

let chapters=[], buttons={}, current=null;
let qs=[], queue=[], score=0, corr=0, wrong=0, total=0;
let complete=true, done=new Set(), chapScores={};

function loadChapters(){
  Papa.parse('Chapters.csv',{download:true,header:true,skipEmptyLines:true,complete(res){
    chapters=res.data; let m=document.getElementById('menu'); m.innerHTML='选择章节:';
    chapters.forEach(ch=>{ let b=document.createElement('button'); b.textContent=ch.label;
      b.onclick=()=>selectChap(ch.sheet,ch.label); buttons[ch.sheet]=b; m.appendChild(b);});
  }});
}

function selectChap(sheet,label){
  if(current && !complete && !confirm('章节未完成，切换会丢失进度？')) return;
  startChap(sheet,label);
}

function startChap(csv,label){
  Papa.parse(csv,{download:true,header:true,skipEmptyLines:true,complete(res){
    qs=res.data.map(q=>({...q,attempt:0}));
    document.getElementById('quiz-title').textContent=label;
    score=corr=wrong=0; total=qs.length; queue=shuffle([...qs]); current=csv; complete=false;
    document.getElementById('progress').max=total; updateUI(0); nextQ();
  }});
}

function updateUI(delta){
  document.getElementById('score').textContent='得分: '+score+' ('+(delta>0?'+':'')+delta+')';
  document.getElementById('remaining').textContent='剩余题目: '+queue.length;
  document.getElementById('progress').value=total-queue.length;
}

function nextQ(){
  let divQuiz=document.getElementById('quiz'); divQuiz.innerHTML=''; updateUI(0);
  if(queue.length===0){
    complete=true; done.add(current); chapScores[current]=score;
    buttons[current].textContent=document.getElementById('quiz-title').textContent+' ('+score+' 分)';
    divQuiz.innerHTML='<h3>章节完成</h3><p>本章得分: '+score+'</p><p>答对:'+corr+'，答错:'+wrong+'</p>';
    if(done.size===chapters.length) finishAll();
    return;
  }
  let q=queue.shift(); let d=document.createElement('div'); d.className='question';
  d.innerHTML='<p><strong>'+q.question+'</strong></p>';
  if(q.image){let im=document.createElement('img');im.src=q.image;d.appendChild(im);}
  let opts=document.createElement('div'); opts.className='options';
  if(q.type==='text'){ opts.innerHTML='<input type="text" id="txtAns" placeholder="请输入答案，用逗号分隔">'; }
  else{
    let ks=['A','B','C','D','E','F','G','H'].filter(k=>q[k]); shuffle(ks).forEach(l=>{
      let inp=document.createElement('input'); inp.type=q.type==='checkbox'?'checkbox':'radio';
      inp.name='opt'; inp.value=l; inp.id='opt_'+l;
      let lbl=document.createElement('label'); lbl.htmlFor='opt_'+l; lbl.className='option-label';
      lbl.appendChild(inp);
      let raw=q[l]; if(typeof raw==='string' && /^-?\d+\.0$/.test(raw)) raw=String(parseInt(raw));
      // text answer normalize lowercase
      lbl.append(' '+raw); opts.appendChild(lbl);
    });
  }
  d.appendChild(opts);
  let fb=document.createElement('div'); fb.className='feedback'; d.appendChild(fb);
  let sb=document.createElement('button'); sb.textContent='提交'; sb.onclick=function(){
    let ua=[]; if(q.type==='text') ua=document.getElementById('txtAns').value.split(',').map(s=>s.trim()).filter(s=>s);
    else ua=Array.from(d.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
    if(!ua.length) return alert('请先选择或输入答案');
    let isCorrect=false;
    if(q.type==='text'){
      let userInputs=ua.map(s=>s.trim().toLowerCase());
      let correctList=q.answer.split(',').map(s=>s.trim().toLowerCase());
      isCorrect=userInputs.some(v=>correctList.includes(v));
    } else {
      let uaArr=ua.map(s=>s.toUpperCase()).sort().join(',');
      let caArr=q.answer.split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
      isCorrect=uaArr===caArr;
    }
    let delta = isCorrect ? (q.attempt?1:2) : -1;
    score+=delta; if(isCorrect) corr++; else wrong++;
    let ansTxt=(q.type==='text')?q.answer.split(',').join(' / '):
               q.answer.split(',').map(letter=>q[letter]).join(' / ');
    fb.textContent=(isCorrect?'正确! +':'错误! ')+delta+(delta<0?' 正确答案: '+ansTxt:'');
    updateUI(delta); sb.disabled=true; nb.style.display='inline-block';
    if(!isCorrect){ q.attempt++; for(let i=0;i<2;i++){queue.splice(Math.floor(Math.random()*(queue.length+1)),0,{...q});}}
  }; d.appendChild(sb);
  let nb=document.createElement('button'); nb.textContent='下一题'; nb.style.display='none'; nb.onclick=nextQ; d.appendChild(nb);
  divQuiz.appendChild(d);
}

function finishAll(){
  let et=Date.now(), dur=Math.floor((et-startTime)/1000), m=Math.floor(dur/60), s=dur%60;
  let timeStr=m+'分'+s+'秒', totalScore=Object.values(chapScores).reduce((a,b)=>a+b,0);
  let board=JSON.parse(localStorage.getItem('scoreboard')||'[]');
  board.push({name:user,score:totalScore,time:dur});
  board.sort((a,b)=>b.score-a.score || a.time-b.time); board=board.slice(0,5);
  localStorage.setItem('scoreboard',JSON.stringify(board));
  let divQuiz=document.getElementById('quiz');
  divQuiz.innerHTML+='<h3>测验完成！总得分:'+totalScore+'，用时:'+timeStr+'</h3>';
  let tbl='<h3>排行榜 Top 5</h3><table><tr><th>排名</th><th>姓名</th><th>得分</th><th>用时</th></tr>';
  board.forEach((r,i)=>{let mm=Math.floor(r.time/60), ss=r.time%60;tbl+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.score}</td><td>${mm}分${ss}秒</td></tr>`;});
  tbl+='</table>'; divQuiz.innerHTML+=tbl;
}

function shuffle(a){for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
</script>
</body>
</html>