<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>章节测验系统</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:auto; max-width:700px; text-align:center; font-size:18px; }
    #welcome { margin:20px; }
    #main { display:none; }
    #menu { margin:20px 0; }
    #menu button { margin:0 5px; padding:10px 12px; font-size:1em; }
    #quiz-title { font-size:1.8em; margin-bottom:10px; }
    #score,#remaining,#timer { font-size:1.2em; margin:5px 0; }
    #progress { width:100%; height:20px; margin-bottom:10px;}
    .question { text-align:left; margin:20px 0; padding-left:20px; }
    .options { text-align:left; padding-left:20px; }
    .option-label { display:block; margin:5px 0; cursor:pointer; }
    .feedback { font-weight:bold; margin:10px 0; }
    button { padding:8px 16px; margin:5px; font-size:1em; }
    input[type="text"] { width:100%; padding:8px; font-size:1em; margin-top:10px; }
    input[type="radio"], input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
    table { width:100%; border-collapse:collapse; margin-top:10px;}
    th,td { border:1px solid #ccc; padding:8px; }
    th { background:#eee;}
  </style>
</head>
<body>
  <div id="welcome">
    <h2>请输入姓名 / Enter Your Name</h2>
    <input type="text" id="username" placeholder="姓名 / Name">
    <button id="startBtn">开始测验 / Start Quiz</button>
  </div>
  <div id="main">
    <div id="menu">正在加载章节...</div>
    <div id="quiz-title"></div>
    <div id="score">得分: 0</div>
    <div id="remaining">剩余题目: 0</div>
    <div id="timer">用时: 0分0秒</div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="quiz"></div>
  </div>

<script>
let user='', chapterStart=0, chapterTimer=null;
document.getElementById('startBtn').onclick = ()=>{
  const nm = document.getElementById('username').value.trim();
  if(!nm) return alert('请输入姓名 / Please enter your name');
  user = nm;
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  loadChapters();
};

let chapters=[], buttons={}, current=null;
let qs=[], queue=[], score=0, corr=0, wrong=0, total=0;
let complete=true, chapScores={};

function loadChapters(){
  Papa.parse('Chapters.csv',{download:true,header:true,skipEmptyLines:true,complete(res){
    chapters = res.data;
    const menu = document.getElementById('menu');
    menu.innerHTML = '选择章节:';
    chapters.forEach(ch=>{
      const btn = document.createElement('button');
      btn.textContent = ch.label;
      btn.onclick = ()=>selectChap(ch.sheet, ch.label);
      buttons[ch.sheet] = btn;
      menu.appendChild(btn);
    });
  }});
}

function selectChap(sheet,label){
  if(current && !complete && !confirm('章节未完成，切换会丢失进度？')) return;
  startChap(sheet,label);
}

function startChap(csv,label){
  Papa.parse(csv,{download:true,header:true,skipEmptyLines:true,complete(res){
    qs = res.data.map(q=>({...q,attempt:0}));
    document.getElementById('quiz-title').textContent = label;
    score = corr = wrong = 0;
    total = qs.length;
    queue = shuffle([...qs]);
    current = csv;
    complete = false;
    // start chapter timer
    clearInterval(chapterTimer);
    chapterStart = Date.now();
    document.getElementById('timer').textContent = '用时: 0分0秒';
    chapterTimer = setInterval(updateChapterTimer, 1000);

    document.getElementById('progress').max = total;
    updateUI(0);
    nextQ();
  }});
}

function updateChapterTimer(){
  const elapsed = Math.floor((Date.now() - chapterStart)/1000);
  const m = Math.floor(elapsed/60), s = elapsed%60;
  document.getElementById('timer').textContent = '用时: ' + m + '分' + s + '秒';
}

function updateUI(delta){
  document.getElementById('score').textContent = '得分: ' + score + ' (' + (delta>0?'+':'') + delta + ')';
  document.getElementById('remaining').textContent = '剩余题目: ' + queue.length;
  document.getElementById('progress').value = total - queue.length;
}

function nextQ(){
  const divQuiz = document.getElementById('quiz');
  divQuiz.innerHTML = '';
  updateUI(0);
  if(queue.length === 0){
    complete = true;
    clearInterval(chapterTimer);
    chapScores[current] = score;
    const dur = Math.floor((Date.now()-chapterStart)/1000);
    const m = Math.floor(dur/60), s = dur%60;
    const tstr = m+'分'+s+'秒';
    const btn = buttons[current];
    btn.textContent = document.getElementById('quiz-title').textContent + ' (' + score + ' 分)';
    divQuiz.innerHTML = '<h3>章节完成</h3><p>本章得分: '+score+'，用时: '+tstr+'</p>';
    // show chapter leaderboard
    const key = 'lb_'+current;
    let lb = JSON.parse(localStorage.getItem(key)||'[]');
    lb.push({name:user,score:score,time:dur});
    lb.sort((a,b)=>b.score-a.score || a.time-b.time);
    lb = lb.slice(0,5);
    localStorage.setItem(key, JSON.stringify(lb));
    let tbl = '<h3>本章排行榜 Top 5</h3><table><tr><th>排名</th><th>姓名</th><th>得分</th><th>用时</th></tr>';
    lb.forEach((r,i)=>{ const mm2=Math.floor(r.time/60), ss2=r.time%60;
      tbl += '<tr><td>'+(i+1)+'</td><td>'+r.name+'</td><td>'+r.score+'</td><td>'+mm2+'分'+ss2+'秒</td></tr>';
    });
    tbl += '</table>';
    divQuiz.innerHTML += tbl;
    return;
  }
  const q = queue.shift();
  const d = document.createElement('div'); d.className = 'question';
  d.innerHTML = '<p><strong>'+q.question+'</strong></p>';
  if(q.image){ const im=document.createElement('img'); im.src=q.image; d.appendChild(im); }
  const opts = document.createElement('div'); opts.className='options';
  if(q.type==='text'){
    opts.innerHTML = '<input type="text" id="txtAns" placeholder="请输入答案，用逗号分隔">';
  } else {
    const ks = ['A','B','C','D','E','F','G','H'].filter(k=>q[k]);
    shuffle(ks).forEach(l=>{
      const inp = document.createElement('input');
      inp.type = (q.type==='checkbox'?'checkbox':'radio');
      inp.name='opt'; inp.value=l; inp.id='opt_'+l;
      const lbl = document.createElement('label'); lbl.htmlFor='opt_'+l; lbl.className='option-label';
      lbl.appendChild(inp);
      let raw = q[l]; 
      if(/^-?\d+\.0$/.test(raw)) raw = String(parseInt(raw));
      lbl.append(' '+raw);
      opts.appendChild(lbl);
    });
  }
  d.appendChild(opts);
  const fb = document.createElement('div'); fb.className='feedback'; d.appendChild(fb);
  const sb = document.createElement('button'); sb.textContent='提交';
  sb.onclick = function(){
    let ua = [];
    if(q.type==='text'){
      ua = document.getElementById('txtAns').value.split(',').map(s=>s.trim()).filter(s=>s);
    } else {
      ua = Array.from(d.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
    }
    if(!ua.length) return alert('请先选择或输入答案');
    let isCorrect=false;
    if(q.type==='text'){
      const lowerUA = ua.map(s=>s.toLowerCase());
      const lowerAns = q.answer.split(',').map(s=>s.toLowerCase());
      isCorrect = lowerUA.some(v=>lowerAns.includes(v));
    } else {
      const uaArr = ua.map(s=>s.toUpperCase()).sort().join(',');
      const caArr = q.answer.split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
      isCorrect = uaArr === caArr;
    }
    const delta = isCorrect ? (q.attempt?1:2) : -1;
    score += delta; if(isCorrect) corr++; else wrong++;
    let ansTxt = (q.type==='text')? q.answer.replace(/,/g,' / ') : 
      q.answer.split(',').map(letter=>q[letter]).join(' / ');
    fb.textContent = (isCorrect?'正确! +':'错误! ') + delta + (delta<0? ' 正确答案: '+ansTxt : '');
    updateUI(delta);
    sb.disabled=true; nb.style.display='inline-block';
    if(!isCorrect){
      q.attempt++;
      for(let i=0;i<2;i++){
        queue.splice(Math.floor(Math.random()*(queue.length+1)),0,{...q});
      }
    }
  };
  d.appendChild(sb);
  const nb = document.createElement('button'); nb.textContent='下一题'; nb.style.display='none'; nb.onclick=nextQ; d.appendChild(nb);
  document.getElementById('quiz').appendChild(d);
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
</script>
</body>
</html>